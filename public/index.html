<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IECC WTR Manager Dashboard</title>

  <!-- Clerk (latest) -->
  <script async crossorigin="anonymous" data-clerk-publishable-key="${CLERK_PUBLISHABLE_KEY}"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
    </script>

  <style>
    /* === Your original styles kept, with tiny polish === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0072bc 0%, #004c8c 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header img {
      max-height: 70px;
      margin-bottom: 15px;
    }

    .header h1 {
      font-size: 2.3rem;
      font-weight: bold;
      color: #004c8c;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1rem;
      color: #0072bc;
      font-weight: 500;
    }

    .controls {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: nowrap;
      align-items: center;
      border-top: 1px solid #e0e0e0;
      border-bottom: 1px solid #e0e0e0;
      padding: 10px 0;
      overflow-x: auto;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding-right: 20px;
      margin-right: 20px;
      border-right: 1px solid #ccc;
      flex-shrink: 0;
    }

    .control-group:last-of-type {
      border-right: none;
      margin-right: 0;
      padding-right: 0;
    }

    .control-group label {
      font-weight: 600;
      color: #004c8c;
      font-size: 0.9rem;
    }

    select,
    input {
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      min-width: 150px;
    }

    select:focus,
    input:focus {
      outline: none;
      border-color: #0072bc;
      box-shadow: 0 0 0 3px rgba(0, 114, 188, 0.15);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      flex-shrink: 0;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0072bc, #004c8c);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 76, 140, 0.3);
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
      padding: 8px 16px;
      font-size: 0.9rem;
    }

    .btn-secondary:hover {
      background: #4b5563;
      transform: translateY(-1px);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      border: 1px solid #bae6fd;
    }

    .stat-card h3 {
      font-size: 2rem;
      font-weight: bold;
      color: #004c8c;
      margin-bottom: 5px;
    }

    .stat-card p {
      color: #0369a1;
      font-weight: 500;
    }

    .table-container {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0, 0, 0, .08);
      border: 1px solid #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: linear-gradient(135deg, #0072bc, #004c8c);
    }

    thead th {
      color: white;
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      font-size: .9rem;
      text-transform: uppercase;
      letter-spacing: .5px;
    }

    tbody tr {
      transition: all .3s ease;
      border-bottom: 1px solid #f1f5f9;
    }

    tbody tr:hover {
      background: #f0f9ff;
      transform: scale(1.01);
    }

    tbody td {
      padding: 14px 12px;
      color: #374151;
      font-size: .9rem;
      box-shadow: inset -1px 0 0 #e5e7eb;
    }

    table th {
      border-right: 1px solid #e5e7eb;
    }

    table td:last-child,
    table th:last-child {
      border-right: none;
    }

    .status-pending {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: .8rem;
      font-weight: 600;
    }

    .status-approved {
      background: linear-gradient(135deg, #16a34a, #15803d);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: .8rem;
      font-weight: 600;
    }

    .status-rejected {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: .8rem;
      font-weight: 600;
    }

    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }

    .rows-per-page {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      color: #64748b;
      font-size: 1.1rem;
    }

    .loading.show {
      display: block;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #64748b;
      font-size: 1.1rem;
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
        flex-wrap: wrap;
      }

      .control-group {
        border-right: none;
        margin-right: 0;
        padding-right: 0;
        margin-bottom: 10px;
      }

      .container {
        padding: 20px;
      }

      .table-container {
        overflow-x: auto;
      }
    }

    .topbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-top: -12px;
      margin-bottom: 16px;
      gap: 8px;
    }

    .chip {
      font-size: .9rem;
      color: #004c8c;
      background: #e6f1fb;
      border: 1px solid #cfe7ff;
      padding: 6px 10px;
      border-radius: 999px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <span id="userDisplay" class="chip">Loading user…</span>
      <button class="btn btn-secondary" id="signOutBtn">Sign Out</button>
    </div>

    <div class="header">
      <img src="IECC Logo.png" alt="IECC Logo"
        style="display:block;margin-left:0;margin-right:auto;width:auto;height:auto;">
      <h1>IECC Work Time Records</h1>
      <p>Approve and manage employee work time submissions</p>
    </div>

    <!-- Filters -->
    <div class="controls">
      <div class="control-group">
        <label>Filter by Status</label>
        <select id="statusFilter">
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>

      <div class="control-group">
        <label>Filter by Department</label>
        <select id="departmentFilter">
          <option value="all">All Departments</option>
        </select>
      </div>

      <div class="control-group">
        <label>Filter by Month</label>
        <select id="monthFilter">
          <option value="all">All Months</option>
          <option value="1">January</option>
          <option value="2">February</option>
          <option value="3">March</option>
          <option value="4">April</option>
          <option value="5">May</option>
          <option value="6">June</option>
          <option value="7">July</option>
          <option value="8">August</option>
          <option value="9">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
      </div>

      <div class="control-group">
        <label>Filter by Year</label>
        <select id="yearFilter">
          <option value="all">All Years</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
        </select>
      </div>

      <div class="control-group">
        <label>Search Employee</label>
        <input type="text" id="searchEmployee" placeholder="Search by name or email">
      </div>

      <button class="btn btn-primary" id="refreshBtn">Refresh Data</button>
    </div>

    <!-- KPIs -->
    <div class="stats" id="statsContainer">
      <div class="stat-card">
        <h3 id="totalRecords">0</h3>
        <p>Total Records</p>
      </div>
      <div class="stat-card">
        <h3 id="pendingRecords">0</h3>
        <p>Pending Approval</p>
      </div>
      <div class="stat-card">
        <h3 id="approvedRecords">0</h3>
        <p>Approved</p>
      </div>
      <div class="stat-card">
        <h3 id="rejectedRecords">0</h3>
        <p>Rejected</p>
      </div>
    </div>

    <div class="loading" id="loading">
      <p>Loading data...</p>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Employee Info</th>
            <th>Period</th>
            <th>Hours</th>
            <th>Activity Details</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>

    <div class="no-data" id="noData" style="display:none;">
      <p>No work time records found. Please check your database connection or add some data.</p>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" id="paginationControls" style="display:none;">
      <div class="rows-per-page">
        <label for="rowsPerPage">Rows per page:</label>
        <select id="rowsPerPage">
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="50">50</option>
        </select>
      </div>
      <span id="pageInfo">Page 1 of 1</span>
      <div>
        <button class="btn btn-secondary" id="prevBtn">Previous</button>
        <button class="btn btn-secondary" id="nextBtn">Next</button>
      </div>
    </div>
  </div>

  <script>
    // ----- Clerk gate -----
    (async () => {
      const waitForClerk = () => new Promise((resolve, reject) => {
        const start = Date.now();
        const t = setInterval(() => {
          if (window.Clerk && typeof window.Clerk.load === 'function') { clearInterval(t); resolve(); }
          else if (Date.now() - start > 10000) { clearInterval(t); reject(new Error('Clerk SDK not loaded in time')); }
        }, 50);
      });

      try {
        await waitForClerk();
        await window.Clerk.load();

        if (!window.Clerk.user) {
          // Not signed in → go to Sign-in page
          window.location.href = 'Sign-in.html';
          return;
        }

        // Show user chip
        const u = window.Clerk.user;
        const name = u.fullName || (u.firstName ? (u.firstName + ' ' + (u.lastName || '')) : (u.primaryEmailAddress?.emailAddress || 'Signed in'));
        const email = u.primaryEmailAddress?.emailAddress || '';
        document.getElementById('userDisplay').textContent = email ? `${name} (${email})` : name;

        document.getElementById('signOutBtn').onclick = async () => {
          try {
            await window.Clerk.signOut();
          } finally {
            window.location.href = 'Sign-in.html';
          }
        };

        // When Clerk is ready & authenticated → boot approvals app
        initApprovalsApp();
      } catch (err) {
        alert('Failed to initialize authentication. Please refresh.');
        console.error(err);
      }
    })();

    // ----- Approvals app (your original logic, kept) -----
    let wtrData = [];
    let filteredData = [];
    let currentPage = 1;
    let rowsPerPage = 10;

    function setupEventListeners() {
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('departmentFilter').addEventListener('change', applyFilters);
      document.getElementById('monthFilter').addEventListener('change', applyFilters);
      document.getElementById('yearFilter').addEventListener('change', applyFilters);
      document.getElementById('searchEmployee').addEventListener('input', applyFilters);

      const rowsSelector = document.getElementById('rowsPerPage');
      rowsSelector.addEventListener('change', function () {
        rowsPerPage = parseInt(this.value, 10);
        currentPage = 1;
        renderData();
        updateStats();
      });

      document.getElementById('refreshBtn').addEventListener('click', loadData);
      document.getElementById('prevBtn').addEventListener('click', prevPage);
      document.getElementById('nextBtn').addEventListener('click', nextPage);
    }

    async function initApprovalsApp() {
      setupEventListeners();
      await loadData();
      await populateDepartmentFilter();
      renderData();
      updateStats();
    }

    async function loadData() {
      const loading = document.getElementById('loading');
      loading.classList.add('show');
      try {
        const r = await fetch('/api/wtr', { credentials: 'include' });
        if (!r.ok) throw new Error('Failed to fetch WTR data');
        wtrData = await r.json();
        filteredData = [...wtrData];
      } catch (e) {
        console.error('Error fetching WTR data:', e);
      } finally {
        loading.classList.remove('show');
      }
    }

    async function populateDepartmentFilter() {
      try {
        const r = await fetch('/api/departments', { credentials: 'include' });
        if (!r.ok) throw new Error('Failed to fetch departments');
        const departments = await r.json();

        const sel = document.getElementById('departmentFilter');
        sel.innerHTML = '<option value="all">All Departments</option>';
        // Accept array of strings OR array of objects with department_name
        (departments || []).forEach(d => {
          const name = typeof d === 'string' ? d : (d.department_name || d.department || d.name || '');
          if (!name) return;
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.error('Error fetching departments:', e);
      }
    }

    function applyFilters() {
      const s = document.getElementById('statusFilter').value;
      const d = document.getElementById('departmentFilter').value;
      const m = document.getElementById('monthFilter').value;
      const y = document.getElementById('yearFilter').value;
      const q = document.getElementById('searchEmployee').value.toLowerCase();

      filteredData = (wtrData || []).filter(item => {
        const status = (item.status || '').toLowerCase();
        const dept = item.department || item.department_name || '';
        const matchesStatus = s === 'all' || status === s.toLowerCase();
        const matchesDepartment = d === 'all' || String(dept) === d;
        const matchesMonth = m === 'all' || String(item.wtr_month) === m;
        const matchesYear = y === 'all' || String(item.wtr_year) === y;
        const matchesSearch = !q ||
          (item.employee_name || '').toLowerCase().includes(q) ||
          (item.employee_email || '').toLowerCase().includes(q);
        return matchesStatus && matchesDepartment && matchesMonth && matchesYear && matchesSearch;
      });

      currentPage = 1;
      renderData();
      updateStats();
    }

    function renderData() {
      const tbody = document.getElementById('dataTable');
      const noDataDiv = document.getElementById('noData');
      const paginationControls = document.getElementById('paginationControls');

      if (!filteredData.length) {
        tbody.innerHTML = '';
        noDataDiv.style.display = 'block';
        paginationControls.style.display = 'none';
        return;
      }

      noDataDiv.style.display = 'none';

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const page = filteredData.slice(start, end);

      tbody.innerHTML = page.map(record => `
        <tr>
          <td>
            <div class="employee-details">
              <strong>${record.employee_name || '-'}</strong><br>
              <small>NUID: ${record.employee_nuid || '-'}</small><br>
              <small>${record.employee_email || '-'}</small><br>
              <small>${record.employee_title || '-'}</small><br>
              <small><em>${record.department || record.department_name || '-'}</em></small>
            </div>
          </td>
          <td>
            <strong>${getMonthName(record.wtr_month)} ${record.wtr_year}</strong><br>
            <small>WTR ID: ${record.coda_wtr_id || record.wtr_id || '-'}</small>
          </td>
          <td>
            <div class="hours-info">
              <strong>Submitted: ${record.total_submitted_hours ?? '-'}h</strong><br>
              <small>Expected: ${record.expected_hours ?? '-'}h</small><br>
              <small>Variance: ${(Number(record.total_submitted_hours) - Number(record.expected_hours) || 0).toFixed(2)
        }h</small>
            </div>
          </td>
          <td>
            <div style="max-width: 300px;">
              ${Array.isArray(record.activities) ? record.activities.map(a => `
                <div style="margin-bottom:8px;padding:8px;background:#f8fafc;border-radius:6px;border-left:3px solid #4f46e5;">
                  <strong>${a.activity_name || '-'}</strong> (${a.hours_submitted ?? '-'}h)<br>
                  <small><strong>Project:</strong> ${a.project_name || '-'}</small><br>
                  <small><strong>Service Line:</strong> ${a.service_line || '-'}</small><br>
                  <small><strong>Description:</strong> ${a.tech_report_description || '-'}</small><br>
                  <small><strong>Log ID:</strong> ${a.coda_log_id || '-'}</small>
                </div>`).join('') : '-'}
            </div>
          </td>
          <td><span class="status-${(record.status || '').toLowerCase()}">${(record.status || '-').toUpperCase()}</span></td>
          <td>
            <div class="action-buttons">
              ${(record.status || '').toLowerCase() === 'pending'
          ? `<button class="btn btn-primary" style="background:linear-gradient(135deg,#16a34a,#15803d)" onclick="updateStatus(${record.wtr_id}, 'approved')">Approve</button>
                   <button class="btn btn-primary" style="background:linear-gradient(135deg,#dc2626,#b91c1c)" onclick="updateStatus(${record.wtr_id}, 'rejected')">Reject</button>`
          : `<button class="btn btn-primary" onclick="updateStatus(${record.wtr_id}, 'pending')" style="font-size:0.9rem;padding:8px 14px;">Reset to Pending</button>`
        }
            </div>
          </td>
        </tr>
      `).join('');

      // Pagination controls
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
      paginationControls.style.display = totalPages > 1 ? 'flex' : 'none';
    }

    function prevPage() { if (currentPage > 1) { currentPage--; renderData(); } }
    function nextPage() {
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      if (currentPage < totalPages) { currentPage++; renderData(); }
    }

    function updateStats() {
      const total = filteredData.length;
      const p = filteredData.filter(r => (r.status || '').toLowerCase() === 'pending').length;
      const a = filteredData.filter(r => (r.status || '').toLowerCase() === 'approved').length;
      const r = filteredData.filter(r => (r.status || '').toLowerCase() === 'rejected').length;
      document.getElementById('totalRecords').textContent = total;
      document.getElementById('pendingRecords').textContent = p;
      document.getElementById('approvedRecords').textContent = a;
      document.getElementById('rejectedRecords').textContent = r;
    }

    async function updateStatus(wtrId, newStatus) {
      try {
        const res = await fetch(`/api/wtr/${wtrId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status: newStatus })
        });
        if (!res.ok) throw new Error('Failed to update status');
        // Reflect locally
        const i = wtrData.findIndex(r => r.wtr_id === wtrId);
        if (i !== -1) wtrData[i].status = newStatus;
        applyFilters();
      } catch (e) {
        console.error('Update status error:', e);
        alert('Failed to update status.');
      }
    }

    function getMonthName(n) {
      const m = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      return m[(Number(n) || 1) - 1];
    }
  </script>
</body>

</html>