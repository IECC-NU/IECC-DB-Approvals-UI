<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IECC Work Time Records</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }

    header {
      margin-bottom: 20px;
    }

    h1 {
      color: #007bff;
      margin-bottom: 10px;
    }

    p {
      color: #666;
      margin-bottom: 20px;
    }

    .filters {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filters div {
      margin-right: 10px;
      margin-bottom: 10px;
    }

    select,
    input {
      padding: 5px;
      width: 150px;
    }

    button {
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }

    button:hover {
      background-color: #0056b3;
    }

    .stats-grid {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: #f0f0f0;
      padding: 10px;
      text-align: center;
      width: 20%;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .stat-number {
      font-size: 1.2em;
      font-weight: bold;
    }

    .stat-label {
      color: #666;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #007bff;
      color: white;
    }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <header>
    Loading user... <button>Sign Out</button>
  </header>

  <h1>IECC Work Time Records</h1>
  <p>Approve and manage employee work time submissions</p>

  <div class="filters">
    <div>
      Filter by Status
      <select id="status-filter">
        <option>All Status</option>
        <option>Pending</option>
        <option>Approved</option>
        <option>Rejected</option>
      </select>
    </div>

    <div>
      Filter by Department
      <select id="dept-filter">
        <option>All Departments</option>
        <!-- Departments will be populated dynamically -->
      </select>
    </div>

    <div>
      Filter by Month
      <select id="month-filter">
        <option>All Months</option>
        <option>January</option>
        <option>February</option>
        <option>March</option>
        <option>April</option>
        <option>May</option>
        <option>June</option>
        <option>July</option>
        <option>August</option>
        <option>September</option>
        <option>October</option>
        <option>November</option>
        <option>December</option>
      </select>
    </div>

    <div>
      Filter by Year
      <select id="year-filter">
        <option>All Years</option>
        <option>2024</option>
        <option>2025</option>
        <!-- Add more years if needed -->
      </select>
    </div>

    <div>
      Search Employee
      <input id="search-input" placeholder="Search by name or email">
    </div>

    <button id="refresh-btn">Refresh Data</button>
    <button id="debug-btn">Debug Info</button>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-number" id="total-records">0</span>
      <span class="stat-label">Total Records</span>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="pending-count">0</span>
      <span class="stat-label">Pending Approval</span>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="approved-count">0</span>
      <span class="stat-label">Approved</span>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="rejected-count">0</span>
      <span class="stat-label">Rejected</span>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>EMPLOYEE INFO</th>
        <th>PERIOD</th>
        <th>HOURS</th>
        <th>ACTIVITY DETAILS</th>
        <th>STATUS</th>
        <th>ACTIONS</th>
      </tr>
    </thead>
    <tbody id="records-body">
      <tr>
        <td colspan="6">Loading data...</td>
      </tr>
    </tbody>
  </table>

  <div class="pagination">
    Rows per page: <select id="rows-per-page">
      <option>1</option>
      <option>2</option>
      <option>3</option>
      <option>4</option>
      <option>5</option>
      <option>6</option>
      <option>7</option>
      <option>8</option>
      <option>9</option>
      <option>10</option>
      <option>11</option>
      <option>12</option>
      <option>13</option>
      <option>14</option>
      <option>15</option>
      <option>16</option>
      <option>17</option>
      <option>18</option>
      <option>19</option>
      <option>20</option>
      <option>21</option>
      <option>22</option>
      <option>23</option>
      <option>24</option>
      <option>25</option>
      <option>26</option>
      <option>27</option>
      <option>28</option>
      <option>29</option>
      <option>30</option>
      <option>31</option>
      <option>32</option>
      <option>33</option>
      <option>34</option>
      <option>35</option>
      <option>36</option>
      <option>37</option>
      <option>38</option>
      <option>39</option>
      <option>40</option>
      <option>41</option>
      <option>42</option>
      <option>43</option>
      <option>44</option>
      <option>45</option>
      <option>46</option>
      <option>47</option>
      <option>48</option>
      <option>49</option>
      <option>50</option>
    </select>
    Page <span id="current-page">1</span> of <span id="total-pages">1</span>
    <button id="prev-btn">Previous</button>
    <button id="next-btn">Next</button>
  </div>

  <div id="error-message" class="error"></div>

  <script>
    let allData = [];
    let currentPage = 1;
    let rowsPerPage = 10;
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    document.addEventListener('DOMContentLoaded', async () => {
      await loadDepartments();
      await loadData();
      setupEventListeners();
    });

    async function loadDepartments() {
      try {
        const res = await fetch('/api/departments', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch departments');
        const depts = await res.json();
        const deptSelect = document.getElementById('dept-filter');
        depts.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.department_name;
          opt.textContent = d.department_name;
          deptSelect.appendChild(opt);
        });
      } catch (e) {
        showError('Failed to load departments: ' + e.message);
      }
    }

    async function loadData() {
      try {
        const res = await fetch('/api/wtr', { credentials: 'include' });
        if (!res.ok) {
          if (res.status === 403) {
            window.location.href = '/sign-in';
            return;
          }
          throw new Error(res.statusText);
        }
        allData = await res.json();
        refreshTable();
      } catch (e) {
        showError('Failed to load data: ' + e.message);
      }
    }

    function setupEventListeners() {
      document.getElementById('status-filter').addEventListener('change', () => { currentPage = 1; refreshTable(); });
      document.getElementById('dept-filter').addEventListener('change', () => { currentPage = 1; refreshTable(); });
      document.getElementById('month-filter').addEventListener('change', () => { currentPage = 1; refreshTable(); });
      document.getElementById('year-filter').addEventListener('change', () => { currentPage = 1; refreshTable(); });
      document.getElementById('search-input').addEventListener('input', () => { currentPage = 1; refreshTable(); });
      document.getElementById('refresh-btn').addEventListener('click', loadData);
      document.getElementById('debug-btn').addEventListener('click', async () => {
        try {
          const res = await fetch('/api/debug/dbinfo', { credentials: 'include' });
          const debugData = await res.json();
          console.log(debugData);
          alert('Check console for debug info');
        } catch (e) {
          showError('Failed to get debug info');
        }
      });
      document.getElementById('rows-per-page').addEventListener('change', (e) => {
        rowsPerPage = parseInt(e.target.value);
        currentPage = 1;
        refreshTable();
      });
      document.getElementById('prev-btn').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          refreshTable();
        }
      });
      document.getElementById('next-btn').addEventListener('click', () => {
        const totalPages = Math.ceil(getFilteredData().length / rowsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          refreshTable();
        }
      });
    }

    function getFilteredData() {
      const statusFilter = document.getElementById('status-filter').value.toLowerCase();
      const deptFilter = document.getElementById('dept-filter').value;
      const monthFilter = document.getElementById('month-filter').value;
      const yearFilter = document.getElementById('year-filter').value;
      const search = document.getElementById('search-input').value.toLowerCase();

      let filtered = allData;

      if (statusFilter !== 'all status') {
        filtered = filtered.filter(r => r.status.toLowerCase() === statusFilter);
      }
      if (deptFilter !== 'All Departments') {
        filtered = filtered.filter(r => r.department_name === deptFilter);
      }
      if (monthFilter !== 'All Months') {
        const monthNum = monthNames.indexOf(monthFilter) + 1;
        filtered = filtered.filter(r => r.wtr_month === monthNum);
      }
      if (yearFilter !== 'All Years') {
        filtered = filtered.filter(r => r.wtr_year === parseInt(yearFilter));
      }
      if (search) {
        filtered = filtered.filter(r =>
          r.employee_name.toLowerCase().includes(search) ||
          r.employee_email.toLowerCase().includes(search)
        );
      }

      return filtered;
    }

    function refreshTable() {
      const filtered = getFilteredData();
      const tbody = document.getElementById('records-body');
      tbody.innerHTML = '';
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">No work time records found. Please check your database connection or add some data.</td></tr>';
      } else {
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filtered.slice(start, end);

        pageData.forEach(record => {
          const row = document.createElement('tr');

          // Employee Info
          const employeeTd = document.createElement('td');
          employeeTd.innerHTML = `${record.employee_name}<br>NUID: ${record.employee_nuid}<br>${record.employee_email}<br>${record.employee_title}<br>${record.department_name}`;
          row.appendChild(employeeTd);

          // Period
          const periodTd = document.createElement('td');
          periodTd.innerHTML = `${monthNames[record.wtr_month - 1]} ${record.wtr_year}<br>WTR ID: ${record.coda_wtr_id}`;
          row.appendChild(periodTd);

          // Hours
          const hoursTd = document.createElement('td');
          const variance = record.expected_hours - record.total_submitted_hours;
          hoursTd.innerHTML = `Submitted: ${record.total_submitted_hours.toFixed(2)}h<br>Expected: ${record.expected_hours.toFixed(2)}h<br>Variance: ${variance.toFixed(2)}h`;
          row.appendChild(hoursTd);

          // Activity Details
          const activityTd = document.createElement('td');
          if (record.activities.length === 0) {
            activityTd.textContent = 'No activity details available. This record may be missing activity data or the activities haven\'t been loaded yet.';
          } else {
            const ul = document.createElement('ul');
            record.activities.forEach(act => {
              const li = document.createElement('li');
              li.innerHTML = `${act.activity_name}: ${act.hours_submitted.toFixed(2)}h<br>Project: ${act.project_name || 'N/A'}<br>Service Line: ${act.service_line || 'N/A'}<br>Description: ${act.tech_report_description || 'N/A'}`;
              ul.appendChild(li);
            });
            activityTd.appendChild(ul);
          }
          row.appendChild(activityTd);

          // Status
          const statusTd = document.createElement('td');
          statusTd.textContent = record.status.toUpperCase();
          row.appendChild(statusTd);

          // Actions
          const actionsTd = document.createElement('td');
          if (record.status.toLowerCase() === 'pending') {
            const approveBtn = document.createElement('button');
            approveBtn.textContent = 'Approve';
            approveBtn.onclick = () => updateStatus(record.wtr_id, 'approved');
            actionsTd.appendChild(approveBtn);

            const rejectBtn = document.createElement('button');
            rejectBtn.textContent = 'Reject';
            rejectBtn.onclick = () => updateStatus(record.wtr_id, 'rejected');
            actionsTd.appendChild(rejectBtn);
          } else {
            const resetBtn = document.createElement('button');
            resetBtn.textContent = 'Reset to Pending';
            resetBtn.onclick = () => updateStatus(record.wtr_id, 'pending');
            actionsTd.appendChild(resetBtn);
          }
          row.appendChild(actionsTd);

          tbody.appendChild(row);
        });
      }

      // Update stats
      const total = filtered.length;
      const pending = filtered.filter(r => r.status.toLowerCase() === 'pending').length;
      const approved = filtered.filter(r => r.status.toLowerCase() === 'approved').length;
      const rejected = filtered.filter(r => r.status.toLowerCase() === 'rejected').length;

      document.getElementById('total-records').textContent = total;
      document.getElementById('pending-count').textContent = pending;
      document.getElementById('approved-count').textContent = approved;
      document.getElementById('rejected-count').textContent = rejected;

      // Update pagination
      const totalPages = Math.ceil(filtered.length / rowsPerPage);
      document.getElementById('current-page').textContent = currentPage;
      document.getElementById('total-pages').textContent = totalPages;
      document.getElementById('prev-btn').disabled = currentPage === 1;
      document.getElementById('next-btn').disabled = currentPage === totalPages;
    }

    async function updateStatus(id, status) {
      try {
        const res = await fetch(`/api/wtr/${id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
          credentials: 'include'
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}: Failed to update status`);
        await loadData(); // Refresh data after update
      } catch (e) {
        showError(e.message);
      }
    }

    function showError(message) {
      document.getElementById('error-message').textContent = message;
    }
  </script>
</body>

</html>